@page "/{*ingressPath:nonfile}"
@rendermode InteractiveServer
@implements IAsyncDisposable

<PageTitle>Nebula Management</PageTitle>

<div class="min-h-screen bg-nebula-bg text-nebula-text">
    <div class="mx-auto max-w-7xl px-4 py-6 md:px-8 md:py-10">
        <section class="mb-6 rounded-2xl border border-nebula-border bg-nebula-surface/90 p-6 shadow-xl">
            <div class="flex flex-wrap items-start justify-between gap-4">
                <div>
                    <p class="text-xs uppercase tracking-[0.24em] text-nebula-muted">NebulaRAG</p>
                    <h1 class="mt-1 text-3xl font-semibold md:text-4xl">Management Dashboard</h1>
                    <p class="mt-2 text-sm text-nebula-muted">Operational tabs for RAG, memory, plans, and telemetry.</p>
                </div>
                <button class="rounded-lg border border-nebula-accent px-4 py-2 text-sm font-medium text-nebula-text transition hover:bg-nebula-accent/20" @onclick="RefreshAsync">
                    Refresh
                </button>
            </div>
        </section>

        <section class="mb-6 flex flex-wrap gap-2 rounded-xl border border-nebula-border bg-nebula-surface p-2">
            @foreach (var tab in _tabs)
            {
                <button class="rounded-lg px-4 py-2 text-sm font-medium transition @GetTabClass(tab)" @onclick="() => _activeTab = tab">
                    @tab
                </button>
            }
        </section>

        @if (_activeTab == DashboardTab.Overview)
        {
            <OverviewManagementTab RefreshNonce="@_refreshNonce" />
        }

        @if (_activeTab == DashboardTab.Rag)
        {
            <RagManagementTab RefreshNonce="@_refreshNonce" />
        }

        @if (_activeTab == DashboardTab.Memory)
        {
            <MemoryManagementTab RefreshNonce="@_refreshNonce" />
        }

        @if (_activeTab == DashboardTab.Plans)
        {
            <PlansManagementTab RefreshNonce="@_refreshNonce" />
        }
    </div>
</div>

@code {
    [Parameter]
    public string? IngressPath { get; set; }

    private enum DashboardTab
    {
        Overview,
        Rag,
        Memory,
        Plans
    }

    private readonly DashboardTab[] _tabs = [DashboardTab.Overview, DashboardTab.Rag, DashboardTab.Memory, DashboardTab.Plans];
    private PeriodicTimer? _refreshTimer;
    private CancellationTokenSource? _refreshCancellation;
    private DashboardTab _activeTab = DashboardTab.Overview;
    private long _refreshNonce = 1;

    protected override async Task OnInitializedAsync()
    {
        _refreshCancellation = new CancellationTokenSource();
        _refreshTimer = new PeriodicTimer(TimeSpan.FromSeconds(20));
        _ = RunRefreshLoopAsync(_refreshCancellation.Token);
        _refreshNonce++;
    }

    private async Task RunRefreshLoopAsync(CancellationToken cancellationToken)
    {
        if (_refreshTimer is null)
        {
            return;
        }

        try
        {
            while (await _refreshTimer.WaitForNextTickAsync(cancellationToken))
            {
                await InvokeAsync(TriggerRefresh);
            }
        }
        catch (OperationCanceledException)
        {
        }
    }

    private Task RefreshAsync()
    {
        TriggerRefresh();
        return Task.CompletedTask;
    }

    private string GetTabClass(DashboardTab tab)
    {
        return _activeTab == tab
            ? "border border-nebula-accent bg-nebula-accent/20 text-nebula-text"
            : "border border-transparent text-nebula-muted hover:border-nebula-border hover:text-nebula-text";
    }

    private void TriggerRefresh()
    {
        _refreshNonce++;
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        if (_refreshCancellation is not null)
        {
            await _refreshCancellation.CancelAsync();
            _refreshCancellation.Dispose();
        }

        _refreshTimer?.Dispose();
    }
}
