@using System.Globalization

<section class="mb-6 grid gap-4 lg:grid-cols-2">
    <article class="rounded-xl border border-nebula-border bg-nebula-surface p-4">
        <h2 class="mb-3 text-lg font-semibold">Semantic Search</h2>
        <div class="space-y-3">
            <input class="w-full rounded-lg border border-nebula-border bg-nebula-bg px-3 py-2" @bind="_queryText" placeholder="Search query" />
            <input class="w-full rounded-lg border border-nebula-border bg-nebula-bg px-3 py-2" type="number" min="1" max="20" @bind="_queryLimit" />
            <button class="rounded-lg border border-nebula-accent px-3 py-2 text-sm hover:bg-nebula-accent/20" @onclick="RunQueryAsync">Run Query</button>
        </div>
    </article>

    <article class="rounded-xl border border-nebula-border bg-nebula-surface p-4">
        <h2 class="mb-3 text-lg font-semibold">Index & Maintenance</h2>
        <div class="space-y-3">
            <input class="w-full rounded-lg border border-nebula-border bg-nebula-bg px-3 py-2" @bind="_indexPath" placeholder="Source path to index" />
            <button class="rounded-lg border border-nebula-accent px-3 py-2 text-sm hover:bg-nebula-accent/20" @onclick="IndexSourceAsync">Index Path</button>
            <input class="w-full rounded-lg border border-nebula-border bg-nebula-bg px-3 py-2" @bind="_deleteSourcePath" placeholder="Exact source path to delete" />
            <button class="rounded-lg border border-amber-500 px-3 py-2 text-sm hover:bg-amber-500/20" @onclick="OpenDeleteSourceConfirm">Delete Source</button>
            <button class="rounded-lg border border-red-500 px-3 py-2 text-sm hover:bg-red-500/20" @onclick="OpenPurgeConfirm">Purge All</button>
        </div>
    </article>
</section>

@if (!string.IsNullOrWhiteSpace(_statusMessage))
{
    <section class="mb-4 rounded-xl border p-4 text-sm @(_statusIsError ? "border-amber-500/70 bg-amber-500/10" : "border-nebula-ok/70 bg-nebula-ok/10")">
        @_statusMessage
    </section>
}

<section class="mb-6 rounded-xl border border-nebula-border bg-nebula-surface p-4">
    <h3 class="mb-3 text-base font-semibold">Query Results</h3>
    <div class="overflow-x-auto">
        <table class="w-full border-collapse text-sm">
            <thead>
                <tr class="text-left text-xs uppercase tracking-[0.12em] text-nebula-muted">
                    <th class="border-b border-nebula-border px-3 py-2">Source</th>
                    <th class="border-b border-nebula-border px-3 py-2">Score</th>
                    <th class="border-b border-nebula-border px-3 py-2">Snippet</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var match in _queryResults)
                {
                    <tr>
                        <td class="border-b border-nebula-border px-3 py-2">@match.SourcePath</td>
                        <td class="border-b border-nebula-border px-3 py-2">@match.Score.ToString("F3", CultureInfo.InvariantCulture)</td>
                        <td class="border-b border-nebula-border px-3 py-2">@TrimText(match.ChunkText, 180)</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</section>

<section class="rounded-xl border border-nebula-border bg-nebula-surface p-4">
    <h3 class="mb-3 text-base font-semibold">Indexed Sources</h3>
    <div class="overflow-x-auto">
        <table class="w-full border-collapse text-sm">
            <thead>
                <tr class="text-left text-xs uppercase tracking-[0.12em] text-nebula-muted">
                    <th class="border-b border-nebula-border px-3 py-2">Source</th>
                    <th class="border-b border-nebula-border px-3 py-2">Chunks</th>
                    <th class="border-b border-nebula-border px-3 py-2">Indexed</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var source in _sources)
                {
                    <tr>
                        <td class="border-b border-nebula-border px-3 py-2">@source.SourcePath</td>
                        <td class="border-b border-nebula-border px-3 py-2">@source.ChunkCount</td>
                        <td class="border-b border-nebula-border px-3 py-2">@source.IndexedAt.ToUniversalTime().ToString("yyyy-MM-dd HH:mm 'UTC'", CultureInfo.InvariantCulture)</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</section>

<ConfirmationModal IsOpen="@_showPurgeConfirm" Title="Purge Entire Index" Message="This will delete all indexed RAG documents and chunks. This action cannot be undone." OnConfirm="ConfirmPurgeAsync" OnCancel="CloseAllConfirm" />
<ConfirmationModal IsOpen="@_showDeleteSourceConfirm" Title="Delete Indexed Source" Message="Delete this source and all its chunks from the index?" OnConfirm="ConfirmDeleteSourceAsync" OnCancel="CloseAllConfirm" />
